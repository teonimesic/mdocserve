name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  version-bump:
    # Skip if the commit message contains version bump indicators (only for push events)
    if: "github.event_name == 'workflow_dispatch' || (!contains(github.event.head_commit.message, 'Bump version') && !contains(github.event.head_commit.message, '[skip ci]'))"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Determine bump type (manual workflow_dispatch or auto patch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
          else
            BUMP_TYPE="patch"
          fi
          echo "Bump type: $BUMP_TYPE"

          # Calculate new version based on bump type
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          case $BUMP_TYPE in
            major)
              NEW_VERSION="$((major + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${major}.$((minor + 1)).0"
              ;;
            patch)
              NEW_VERSION="${major}.${minor}.$((patch + 1))"
              ;;
          esac

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update package.json
          npm version $NEW_VERSION --no-git-tag-version

          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml

      - name: Commit and tag
        run: |
          git add package.json Cargo.toml
          git commit -m "Bump version to ${{ steps.bump.outputs.version }} [skip ci]"
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin main
          git push origin "v${{ steps.bump.outputs.version }}"

  build:
    needs: version-bump
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: aarch64-unknown-linux-musl
            os: ubuntu-24.04-arm
          - target: x86_64-apple-darwin
            os: macos-15-intel
          - target: aarch64-apple-darwin
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v5
      with:
        ref: v${{ needs.version-bump.outputs.version }}

    - name: Report Rust version
      run: rustup show

    - name: Install target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --check

    - name: Run clippy
      run: cargo clippy --all-targets --all-features --target ${{ matrix.target }} -- -D warnings

    - name: Run tests
      run: cargo test --target ${{ matrix.target }}

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Prepare artifact
      run: |
        mkdir -p dist
        cp target/${{ matrix.target }}/release/mdocserve dist/mdocserve-${{ matrix.target }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mdocserve-${{ matrix.target }}
        path: dist/mdocserve-${{ matrix.target }}

  publish-crate:
    needs: [version-bump, build]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        ref: v${{ needs.version-bump.outputs.version }}

    - name: Report Rust version
      run: rustup show

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-x86_64-unknown-linux-gnu-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Publish to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: cargo publish

  release:
    needs: [version-bump, build]
    runs-on: ubuntu-latest

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: mdocserve-*
        path: artifacts
        merge-multiple: true

    - name: Package binaries for npm
      run: |
        cd artifacts

        # Map Rust targets to npm binary names and create archives
        # macOS Intel
        if [ -f mdocserve-x86_64-apple-darwin ]; then
          cp mdocserve-x86_64-apple-darwin mdocserve-darwin-x64
          tar -czf mdocserve-darwin-x64.tar.gz mdocserve-darwin-x64
          rm mdocserve-darwin-x64
        fi

        # macOS ARM
        if [ -f mdocserve-aarch64-apple-darwin ]; then
          cp mdocserve-aarch64-apple-darwin mdocserve-darwin-arm64
          tar -czf mdocserve-darwin-arm64.tar.gz mdocserve-darwin-arm64
          rm mdocserve-darwin-arm64
        fi

        # Linux x64 (gnu)
        if [ -f mdocserve-x86_64-unknown-linux-gnu ]; then
          cp mdocserve-x86_64-unknown-linux-gnu mdocserve-linux-x64
          tar -czf mdocserve-linux-x64.tar.gz mdocserve-linux-x64
          rm mdocserve-linux-x64
        fi

        # Linux ARM64 (gnu)
        if [ -f mdocserve-aarch64-unknown-linux-gnu ]; then
          cp mdocserve-aarch64-unknown-linux-gnu mdocserve-linux-arm64
          tar -czf mdocserve-linux-arm64.tar.gz mdocserve-linux-arm64
          rm mdocserve-linux-arm64
        fi

        ls -la

    - name: Create Release and Upload Artifacts
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ needs.version-bump.outputs.version }}
        artifacts: artifacts/*.tar.gz
        draft: true
        allowUpdates: true
        updateOnlyUnreleased: true
        token: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    needs: [version-bump, release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v5
      with:
        ref: v${{ needs.version-bump.outputs.version }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'

    - name: Publish to npm
      run: npm publish --provenance --access public
